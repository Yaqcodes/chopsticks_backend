<!DOCTYPE html>
<html>
<head>
    <title>OAuth Callback</title>
    <script>
        // Send success message to parent window
        function sendSuccessMessage(tokens, user) {
            if (window.opener) {
                window.opener.postMessage({
                    type: 'GOOGLE_OAUTH_SUCCESS',
                    accessToken: tokens.access,
                    refreshToken: tokens.refresh,
                    user: user
                }, '*');
                window.close();
            }
        }

        // Send error message to parent window
        function sendErrorMessage(error) {
            if (window.opener) {
                window.opener.postMessage({
                    type: 'GOOGLE_OAUTH_ERROR',
                    error: error
                }, '*');
                window.close();
            }
        }

        // Handle the OAuth callback
        async function handleOAuthCallback() {
            try {
                // Check if we have tokens from Django template context
                {% if tokens and user %}
                    console.log('Tokens and user found in template context');
                    const tokens = {{ tokens|safe }};
                    const user = {{ user|safe }};
                    sendSuccessMessage(tokens, user);
                    return;
                {% endif %}
                
                // Check if we have an error from Django template context
                {% if error %}
                    console.log('Error found in template context: {{ error }}');
                    sendErrorMessage('{{ error }}');
                    return;
                {% endif %}
                
                console.log('No template context, processing URL parameters...');
                
                // If no context data, try to get code from URL
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                
                if (!code) {
                    sendErrorMessage('No authorization code received');
                    return;
                }

                console.log('Code found in URL, exchanging for tokens...');

                // Exchange code for tokens via backend
                const response = await fetch('/api/auth/google/callback/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    sendErrorMessage(errorData.error || 'OAuth callback failed');
                    return;
                }

                const data = await response.json();
                sendSuccessMessage(data.tokens, data.user);

            } catch (error) {
                console.error('OAuth callback error:', error);
                sendErrorMessage('OAuth callback failed: ' + error.message);
            }
        }

        // Start processing when page loads
        window.onload = handleOAuthCallback;
    </script>
</head>
<body>
    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
        <h2>Processing OAuth...</h2>
        <p>Please wait while we complete your authentication.</p>
        <div style="margin: 20px;">
            <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>

{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Link Loyalty Card to User{% endblock %}

{% block extrahead %}
<style>
    .link-card-container {
        max-width: 600px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .card-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .card-info h3 {
        margin: 0 0 10px 0;
        color: #333;
    }
    
    .card-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        font-size: 14px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }
    
    .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }
    
    .form-group select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
    .button-group {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #545b62;
    }
    
    .warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="link-card-container">
    <h1>Link Loyalty Card to User</h1>
    
    <div class="card-info">
        <h3>Card Information</h3>
        <div class="card-details">
            <div><strong>QR Code:</strong> {{ loyalty_card.qr_code }}</div>
            <div><strong>Status:</strong> 
                {% if loyalty_card.user %}
                    <span style="color: green;">âœ“ Active</span>
                {% else %}
                    <span style="color: #999;">Unassigned</span>
                {% endif %}
            </div>
            <div><strong>Created:</strong> {{ loyalty_card.created_at|date:"M d, Y" }}</div>
            <div><strong>Last Scan:</strong> 
                {% if loyalty_card.last_scan %}
                    {{ loyalty_card.last_scan|date:"M d, Y H:i" }}
                {% else %}
                    Never
                {% endif %}
            </div>
        </div>
    </div>
    
    {% if loyalty_card.user %}
        <div class="warning">
            <strong>Note:</strong> This card is already linked to <strong>{{ loyalty_card.user.email }}</strong>.
            You can change the assignment below.
        </div>
    {% endif %}
    
    <form method="post">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="user_id">Select User:</label>
            <select name="user_id" id="user_id" required>
                <option value="">-- Select a user --</option>
                {% for user in users %}
                    <option value="{{ user.id }}" {% if loyalty_card.user == user %}selected{% endif %}>
                        {{ user.email }} {% if user.first_name or user.last_name %}({{ user.first_name }} {{ user.last_name }}){% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="button-group">
            <a href="{% url 'admin:loyalty_loyaltycard_change' loyalty_card.id %}" class="btn btn-secondary">
                Cancel
            </a>
            <button type="submit" class="btn btn-primary">
                {% if loyalty_card.user %}
                    Update Assignment
                {% else %}
                    Link Card to User
                {% endif %}
            </button>
        </div>
    </form>
    
    <div style="margin-top: 30px; padding: 15px; background: #e9ecef; border-radius: 4px;">
        <h4>What happens when you link a card?</h4>
        <ul style="margin: 0; padding-left: 20px;">
            <li>The card becomes <strong>active</strong> and can be scanned</li>
            <li>The user can earn points when the card is scanned</li>
            <li>Only one user can be assigned to each card</li>
            <li>If the user already has a card, you'll see a warning</li>
        </ul>
    </div>
</div>
{% endblock %}
